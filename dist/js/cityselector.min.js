!function(t){function e(i,a){if(!a.dataSource)throw"dataSource is not set.";var r=this,c=a.dataSource,l=i.data("init");r.config=t.extend({},e["default"],a),r.timestamp=l,r.target=i,o.init(this),"function"==typeof c&&(c=c()),"string"==typeof c?n.getData(r.config.cache,r.config.dataSource,function(t){r.target.trigger("cse:ajaxSuccess",t),r.dataSource=n.sort(t),r.render()},function(){r.target.trigger("cse:ajaxError",arguments)}):"function"==typeof c.then?c.then(function(t){r.dataSource=n.sort(t),r.render()}):(r.dataSource=n.sort(c),r.render()),setTimeout(function(){r.getLocation()},500)}var i=window.localStorage,n={sort:function(t){return t.length&&"object"==typeof t?t.map(function(t){return t.spell=t.alpha.replace(/\-/gi,""),t.initial=t.alpha.split("-").map(function(t){return t[0]}).join(""),t}).sort(function(t,e){return(t.alpha[0]?t.alpha[0].charCodeAt():0)-(e.alpha[0]?e.alpha[0].charCodeAt():0)}):null},find:function(t,e,i){var n=0,o=t.length,a=null;for(n=0;o>n;n++)if(i){if(t[n].key===e){a=t[n];break}}else if(0===t[n].name.indexOf(e)){a=t[n];break}return a},getCache:function(t){var e=null;if(!i||!t)return null;e=i.getItem("__cityselector__")||null;try{if(e=JSON.parse(e),t===!0||e.time&&e.data&&(+new Date-e.time)/1e3<t)return e.data}catch(n){}return e},setCache:function(t){var e=+new Date,n={time:e,data:t};i&&i.setItem("__cityselector__",JSON.stringify(n))},getData:function(e,i,n,o){var a=this,r=this.getCache(e);r&&n.call(null,r),t.ajax({url:i,dataType:"json",success:function(){a.setCache(arguments[0]),n.apply(null,arguments)},error:function(){o.apply(null,arguments)}})}},o={init:function(t){this._list={},this.bind=t},push:function(t,e){this._list[t]=e},attach:function(){return"function"!=typeof this._list[arguments[0]]?arguments[1]:this._list[arguments[0]].apply(this.bind,Array.prototype.slice.call(arguments,1))}};e.prototype={constructor:e,render:function(i){var n=this,o=i||n.dataSource,a=!!i,r="",c=0,l="",s=null,u="",d="";if(!o)throw"data format is incorrect";if(o.forEach(function(t,i){l=t.alpha[0]?t.alpha[0]:"",s&&l!==s&&!a&&(u+=e.template.CATEGORY.replace(/{category}/g,s.toUpperCase()).replace("@@CITYLIST@@",d),d=""),d+=e.template.CITYLIST.replace(/{key}/g,t.key).replace(/{name}/g,t.name),s=l}),a)u='<ul class="city-list">'+d+"</ul>";else for(u+=e.template.CATEGORY.replace(/{category}/g,s.toUpperCase()).replace("@@CITYLIST@@",d),c=-1;++c<26;)l=String.fromCharCode(65+c),r+=e.template.SIDEBAR.replace(/{category}/g,l);n.dom?(n.dom.find(".city-wrap").html(u),a?n.dom.find(".anchor-list").hide():n.dom.find(".anchor-list").show()):(n.dom=t(e.template.MAIN.replace("@@CATEGORY@@",u).replace("@@SIDEBAR@@",r)),n.dom.attr("id","cityselector-"+n.timestamp),t("body").append(n.dom),n.target.trigger("cse:initialized"),n.dom.find("#search").on("input",function(e){var i=t(this).val();n.search(i)}),n.dom.on("click",".city-list-item",function(e){n.pick(t(this).attr("data"))}),n.dom.on("click","#current",function(t){n.currentLocation&&n.select(n.currentLocation)}),n.target.on("click",function(t){n.open()}),"ontouchend"in document?(n.dom.on("touchstart",".anchor-list li",function(e){var i=t(this).text();n.currentPosition!==i&&(n.currentPosition=i,n.scrollTo(i)),t(this).parent().addClass("active"),n.dom.find(".item-tip").show(),e.preventDefault()}),n.dom.on("touchmove",".anchor-list li",function(e){var i=e.originalEvent.changedTouches[0],o="",a=document.elementFromPoint(i.clientX,i.clientY);t(a).parent().hasClass("anchor-list")&&(o=t(a).text(),n.currentPosition!==o&&(n.currentPosition=o,n.scrollTo(o))),e.preventDefault()}),n.dom.on("touchend",".anchor-list li",function(e){t(this).parent().removeClass("active"),n.dom.find(".item-tip").hide()})):n.dom.on("click",".anchor-list li",function(e){var i=t(this).text();n.currentPosition!==i&&(n.currentPosition=i,n.scrollTo(i)),t(this).parent().addClass("active"),n.dom.find(".item-tip").show(),e.preventDefault()}))},open:function(){this.originalTitle=document.title,document.title=this.config.title,this.dom.show().find("#search").val(""),this.target.trigger("cse:opened"),this.render()},close:function(){this.originalTitle&&(document.title=this.originalTitle),this.dom&&this.dom.hide(),this.target.trigger("cse:closed")},search:function(t){var e=this,i=e.dataSource;t=t?t.toLowerCase():t,i=t?i.filter(function(e){return e.key===t||0===e.initial.indexOf(t)||0===e.spell.indexOf(t)||-1!==e.name.indexOf(t)}):i,this.render(t?i:void 0)},pick:function(t){var e=this;t=n.find(e.dataSource,t,!0),null!==t&&(e.current&&e.current.key===t.key||e.target.trigger("cse:changed",t),e.current=t,e.target.html(t.name),e.close())},select:function(t){var e=this;"string"==typeof t&&(e.dataSource?t=n.find(e.dataSource,t):setTimeout(function(){e.select(t)},500)),null!==t&&(e.current&&e.current.key===t.key||e.target.trigger("cse:changed",t),e.current=t,e.target.html(t.name),e.close())},scrollTo:function(t){var e=this.dom.find(".city-wrap"),i=this.dom.find("#category-"+t),n=this.dom.find(".search").height()+this.dom.find(".city-local").height();i.length&&(e[0].scrollTop=e[0].scrollTop-n+i.offset().top,this.dom.find(".item-tip").html(t))},intercept:function(t,e){o.push(t,e)},getLocation:function(t){var e=o.attach("csi:getLocation"),i=this;if(e)"string"==typeof e&&(e={city:e}),i.select(e.city),i.setLocation(),"function"==typeof t&&t(i.current);else if(e===!1);else{var n=document.getElementsByTagName("head")[0]||document.documentElement,a=n.getElementsByTagName("base")[0],r=document.createElement("script");r.charset="utf-8",r.async=!0,r.src="http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=js",r.onload=function(){var e=window.remote_ip_info;delete window.remote_ip_info,i.select(e.province),i.setLocation(),"function"==typeof t&&t(i.current)},a?n.insertBefore(r,a):n.appendChild(r)}},setLocation:function(t){var e=this;t=t||e.current,e.currentLocation=t,e.dom?e.current?e.dom.find("#current").html(e.current.name):e.dom.find("#current").html("定位失败"):e.target.one("cse:initialized",function(){e.dom.find("#current").html(e.current.name)})}},e.template={MAIN:'<div class="cityselector"><div class="search"><input id="search" type="text" placeholder="请输入城市名称或拼音首字母" /></div><div class="city-local">当前定位城市: <span id="current">定位中...</span></div><div class="city-wrap">@@CATEGORY@@</div><ul class="anchor-list">@@SIDEBAR@@</ul><div class="item-tip"></div></div>',SIDEBAR:'<li><a href="javascript:;">{category}</a></li>',CATEGORY:'<p class="city-title" id="category-{category}">{category}</p><ul class="city-list">@@CITYLIST@@</ul>',CITYLIST:'<li class="city-list-item" data="{key}"><span>{name}</span></li>'},e["default"]={title:"城市选择",cache:2592e3};var a={};t.fn.cityselector=function(){if(0===arguments.length||"object"==typeof arguments[0]){var t=+new Date;this.data("init")||(this.data("init",t),a[t]=new e(this,arguments[0]))}else{var i=this.data("init");if(!i)throw"cityselector is not initialized";if(i=a[this.data("init")],"function"!=typeof i[arguments[0]])throw arguments[0]+" is not implemented.";i[arguments[0]].apply(i,Array.prototype.slice.call(arguments,1))}}}(window.Zepto||window.jQuery);